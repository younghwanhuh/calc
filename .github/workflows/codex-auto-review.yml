name: GPT Auto Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches: [main]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  gpt-review:
    runs-on: ubuntu-latest

    env:
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Generate diff
        run: |
          echo "🔍 Generating code diff..."
          git fetch origin main || true
          git diff origin/main...HEAD > diff.txt
          head -n 20 diff.txt || true

      - name: Run GPT Code Review
        run: |
          echo "🤖 Running GPT-based code review..."
          REVIEW=$(curl -s https://api.openai.com/v1/chat/completions \
            -H "Authorization: Bearer $OPENAI_API_KEY" \
            -H "Content-Type: application/json" \
            -d "{
              \"model\": \"gpt-4o-mini\",
              \"messages\": [
                {\"role\": \"system\", \"content\": \"You are an experienced software engineer performing a detailed code review.\"},
                {\"role\": \"user\", \"content\": \"Review the following diff and provide constructive feedback with code suggestions:\\n$(head -c 10000 diff.txt)\"}
              ],
              \"max_tokens\": 800
            }" | jq -r '.choices[0].message.content')
          
          echo "$REVIEW" > codex_review.txt
          echo "✅ Review generated and saved to codex_review.txt"

      - name: Post GPT Review Result
        if: ${{ hashFiles('codex_review.txt') != '' }}
        run: |
          echo "💬 Posting codex_review.txt..."
          
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "PR detected → posting as PR comment"
            gh api repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/comments \
              -f body="$(cat codex_review.txt)"

          elif [ "${{ github.event_name }}" = "push" ]; then
            echo "Push detected → creating issue for review result"
            COMMIT_SHA=$(git rev-parse --short HEAD)
            gh api repos/${{ github.repository }}/issues \
              -f title="🧠 GPT Review Result for commit ${COMMIT_SHA}" \
              -f body="$(cat codex_review.txt)"
          fi
