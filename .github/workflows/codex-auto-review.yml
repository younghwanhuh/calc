name: GPT Auto Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches: [main]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  gpt-review:
    runs-on: ubuntu-latest

    env:
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Ensure jq installed
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Generate diff
        run: |
          echo "ğŸ” ë³€ê²½ëœ ì½”ë“œ ë¹„êµ ì¤‘..."
          git fetch origin main || true
          git diff origin/main...HEAD > diff.txt
          if [ ! -s diff.txt ]; then
            echo "âš ï¸ ë³€ê²½ëœ ì½”ë“œê°€ ì—†ìŠµë‹ˆë‹¤. ë¦¬ë·°ë¥¼ ê±´ë„ˆëœë‹ˆë‹¤."
            exit 0
          fi
          head -n 20 diff.txt || true

      - name: Run GPT Code Review (Korean output, no file)
        id: review
        run: |
          echo "ğŸ¤– OpenAI GPTë¥¼ ì´ìš©í•´ ì½”ë“œ ë¦¬ë·° ìƒì„± ì¤‘..."

          RESPONSE=$(curl -s -w "\n%{http_code}" https://api.openai.com/v1/chat/completions \
            -H "Authorization: Bearer $OPENAI_API_KEY" \
            -H "Content-Type: application/json" \
            -d "{
              \"model\": \"gpt-4o-mini\",
              \"messages\": [
                {\"role\": \"system\", \"content\": \"ë„ˆëŠ” ìˆ™ë ¨ëœ ì‹œë‹ˆì–´ ê°œë°œìë¡œì„œ ì½”ë“œ ë¦¬ë·°ë¥¼ ë‹´ë‹¹í•œë‹¤. í•­ìƒ í•œêµ­ì–´ë¡œ, ê¹”ë”í•œ Markdown í˜•ì‹ìœ¼ë¡œ ë¦¬ë·°ë¥¼ ì‘ì„±í•œë‹¤. í•­ëª©ë³„ë¡œ ë¬¸ì œì ì„ ì§§ê³  ëª…í™•í•˜ê²Œ ì •ë¦¬í•˜ê³ , ê°œì„  ë°©í–¥ì„ ì œì•ˆí•œë‹¤.\"},
                {\"role\": \"user\", \"content\": \"ë‹¤ìŒ Git diffë¥¼ ì½”ë“œ ë¦¬ë·°í•´ì¤˜. ì£¼ìš” ê°œì„ ì , ë²„ê·¸ ê°€ëŠ¥ì„±, ìŠ¤íƒ€ì¼ ê°œì„  ì œì•ˆì„ Markdown ë¦¬ìŠ¤íŠ¸ í˜•ì‹ìœ¼ë¡œ ì‘ì„±í•´ì¤˜.\\n$(head -c 10000 diff.txt)\"}
              ],
              \"max_tokens\": 1000,
              \"temperature\": 0.2
            }")

          # ì‘ë‹µ ë¶„ë¦¬
          HTTP_CODE=$(echo "$RESPONSE" | tail -n 1)
          BODY=$(echo "$RESPONSE" | sed '$d')

          echo "ğŸ” HTTP Status: $HTTP_CODE"
          if [ "$HTTP_CODE" != "200" ]; then
            echo "âŒ OpenAI API ìš”ì²­ ì‹¤íŒ¨:"
            echo "$BODY"
            exit 1
          fi

          REVIEW=$(echo "$BODY" | jq -r '.choices[0].message.content' || true)
          if [ -z "$REVIEW" ] || [ "$REVIEW" = "null" ]; then
            REVIEW="âš ï¸ GPTê°€ ë¦¬ë·° ë‚´ìš©ì„ ë°˜í™˜í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. diffê°€ ë„ˆë¬´ í¬ê±°ë‚˜ API ì œí•œì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤."
          fi

          # GitHub Actions ì¶œë ¥ìœ¼ë¡œ ì „ë‹¬
          REVIEW_ESCAPED=$(echo "$REVIEW" | jq -Rs .)
          echo "review_content=$REVIEW_ESCAPED" >> $GITHUB_OUTPUT

      - name: Post GPT Review Result
        run: |
          echo "ğŸ’¬ ë¦¬ë·° ê²°ê³¼ ê²Œì‹œ ì¤‘..."

          # Actions ì¶œë ¥ ë³€ìˆ˜ì—ì„œ ë¦¬ë·° ë‚´ìš© ì½ê¸°
          REVIEW=$(echo '${{ steps.review.outputs.review_content }}' | jq -r .)

          if [ -z "$REVIEW" ]; then
            echo "âš ï¸ ë¦¬ë·° ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤. ì¢…ë£Œí•©ë‹ˆë‹¤."
            exit 0
          fi
          
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "PR ì´ë²¤íŠ¸ ê°ì§€ë¨ â†’ PR ì½”ë©˜íŠ¸ë¡œ ê²Œì‹œ"
            gh api repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/comments \
              -f body="$REVIEW"

          elif [ "${{ github.event_name }}" = "push" ]; then
            echo "Push ì´ë²¤íŠ¸ ê°ì§€ë¨ â†’ ìƒˆ ì´ìŠˆë¡œ ê²Œì‹œ"
            COMMIT_SHA=$(git rev-parse --short HEAD)
            gh api repos/${{ github.repository }}/issues \
              -f title="ğŸ§  GPT ì½”ë“œ ë¦¬ë·° ê²°ê³¼ (${COMMIT_SHA})" \
              -f body="$REVIEW"
          fi
