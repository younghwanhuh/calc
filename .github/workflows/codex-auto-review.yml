name: GPT Auto Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches: [main]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  gpt-review:
    runs-on: ubuntu-latest

    env:
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # ğŸ‘ˆ ì „ì²´ git ì´ë ¥ ê°€ì ¸ì˜¤ê¸° (HEAD^ ì¸ì‹ ê°€ëŠ¥)

      - name: Ensure jq installed
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq

      # ğŸ‘‡ PRì´ë©´ main ê¸°ì¤€, pushë©´ HEAD^ ê¸°ì¤€ìœ¼ë¡œ diff ìƒì„±
      - name: Generate diff
        run: |
          echo "ğŸ” ë³€ê²½ëœ ì½”ë“œ ë¹„êµ ì¤‘..."
          EVENT="${{ github.event_name }}"

          if [ "$EVENT" = "pull_request" ]; then
            echo "ğŸ“¦ PR ê°ì§€ë¨ â†’ origin/mainê³¼ ë¹„êµ"
            git fetch origin main || true
            git diff origin/main...HEAD > diff.txt
          else
            echo "ğŸš€ Push ê°ì§€ë¨ â†’ ë°”ë¡œ ì´ì „ ì»¤ë°‹ê³¼ ë¹„êµ"

            # ğŸ‘‡ HEAD^ ì¡´ì¬ ì—¬ë¶€ í™•ì¸ (ì²« ì»¤ë°‹ ì˜ˆì™¸ ì²˜ë¦¬)
            if git rev-parse HEAD^ >/dev/null 2>&1; then
              echo "âœ… ì´ì „ ì»¤ë°‹ ì¡´ì¬ â†’ HEAD^ì™€ diff ìƒì„±"
              git diff HEAD^ HEAD > diff.txt
            else
              echo "âš ï¸ ì´ì „ ì»¤ë°‹ì´ ì—†ìŠµë‹ˆë‹¤ (ì²« ì»¤ë°‹ ë˜ëŠ” shallow clone)"
              echo "ğŸ§  ì²« ì»¤ë°‹ì˜ ì „ì²´ ì½”ë“œë¥¼ ë¦¬ë·° ëŒ€ìƒìœ¼ë¡œ ì§€ì •í•©ë‹ˆë‹¤"
              git show HEAD --pretty=format: --no-prefix > diff.txt
            fi
          fi

          if [ ! -s diff.txt ]; then
            echo "âš ï¸ ë³€ê²½ëœ ì½”ë“œê°€ ì—†ìŠµë‹ˆë‹¤. ë¦¬ë·°ë¥¼ ê±´ë„ˆëœë‹ˆë‹¤."
            exit 0
          fi

          echo "âœ… diff.txt ìƒì„± ì™„ë£Œ (ìƒìœ„ 20ì¤„ ë¯¸ë¦¬ë³´ê¸°)"
          head -n 20 diff.txt || true

      - name: Run GPT Code Review (Korean output)
        id: review
        run: |
          echo "ğŸ¤– OpenAI GPTë¥¼ ì´ìš©í•´ ì½”ë“œ ë¦¬ë·° ìƒì„± ì¤‘..."

          RESPONSE=$(curl -s -w "\n%{http_code}" https://api.openai.com/v1/chat/completions \
            -H "Authorization: Bearer $OPENAI_API_KEY" \
            -H "Content-Type: application/json" \
            -d "{
              \"model\": \"gpt-4o-mini\",
              \"messages\": [
                {\"role\": \"system\", \"content\": \"ë„ˆëŠ” ìˆ™ë ¨ëœ ì‹œë‹ˆì–´ ê°œë°œìë¡œì„œ ì½”ë“œ ë¦¬ë·°ë¥¼ ë‹´ë‹¹í•œë‹¤. í•­ìƒ í•œêµ­ì–´ë¡œ, ê¹”ë”í•œ Markdown í˜•ì‹ìœ¼ë¡œ ë¦¬ë·°ë¥¼ ì‘ì„±í•œë‹¤. í•­ëª©ë³„ë¡œ ë¬¸ì œì ì„ ì§§ê³  ëª…í™•í•˜ê²Œ ì •ë¦¬í•˜ê³ , ê°œì„  ë°©í–¥ì„ ì œì•ˆí•œë‹¤.\"},
                {\"role\": \"user\", \"content\": \"ë‹¤ìŒ Git diffë¥¼ ì½”ë“œ ë¦¬ë·°í•´ì¤˜. ì£¼ìš” ê°œì„ ì , ë²„ê·¸ ê°€ëŠ¥ì„±, ìŠ¤íƒ€ì¼ ê°œì„  ì œì•ˆì„ Markdown ë¦¬ìŠ¤íŠ¸ í˜•ì‹ìœ¼ë¡œ ì‘ì„±í•´ì¤˜.\\n$(head -c 10000 diff.txt)\"}
              ],
              \"max_tokens\": 1000,
              \"temperature\": 0.2
            }")

          HTTP_CODE=$(echo "$RESPONSE" | tail -n 1)
          BODY=$(echo "$RESPONSE" | sed '$d')

          echo "ğŸ” HTTP Status: $HTTP_CODE"
          if [ "$HTTP_CODE" != "200" ]; then
            echo "âŒ OpenAI API ìš”ì²­ ì‹¤íŒ¨:"
            echo "$BODY"
            exit 1
          fi

          REVIEW=$(echo "$BODY" | jq -r '.choices[0].message.content' || true)
          if [ -z "$REVIEW" ] || [ "$REVIEW" = "null" ]; then
            REVIEW="âš ï¸ GPTê°€ ë¦¬ë·° ë‚´ìš©ì„ ë°˜í™˜í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. diffê°€ ë„ˆë¬´ í¬ê±°ë‚˜ API ì œí•œì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤."
          fi

          REVIEW_ESCAPED=$(echo "$REVIEW" | jq -Rs .)
          echo "review_content=$REVIEW_ESCAPED" >> $GITHUB_OUTPUT

      - name: Post GPT Review Result
        run: |
          echo "ğŸ’¬ ë¦¬ë·° ê²°ê³¼ ê²Œì‹œ ì¤‘..."
          REVIEW=$(echo '${{ steps.review.outputs.review_content }}' | jq -r .)

          if [ -z "$REVIEW" ]; then
            echo "âš ï¸ ë¦¬ë·° ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤. ì¢…ë£Œí•©ë‹ˆë‹¤."
            exit 0
          fi
          
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "ğŸ“¬ PR ì´ë²¤íŠ¸ ê°ì§€ë¨ â†’ PR ì½”ë©˜íŠ¸ë¡œ ê²Œì‹œ"
            gh api repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/comments \
              -f body="$REVIEW"
          elif [ "${{ github.event_name }}" = "push" ]; then
            echo "ğŸ§  Push ì´ë²¤íŠ¸ ê°ì§€ë¨ â†’ ìƒˆ ì´ìŠˆë¡œ ê²Œì‹œ"
            COMMIT_SHA=$(git rev-parse --short HEAD)
            gh api repos/${{ github.repository }}/issues \
              -f title="ğŸ§  GPT ì½”ë“œ ë¦¬ë·° ê²°ê³¼ (${COMMIT_SHA})" \
              -f body="$REVIEW"
          fi
